<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©tails du groupe</title>
  <style>
    .tab { display: none; }
    .tab.active { display: block; }
    .tab-buttons button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>D√©tails du groupe</h1>
  <p><a href="/accueil">‚¨Ö Retour √† l'accueil</a></p>

  <div class="tab-buttons">
    <button onclick="showTab('info-tab')">üìÑ Infos</button>
    <button onclick="showTab('create-tab')">‚ûï Nouvelle d√©pense</button>
    <button onclick="showTab('expenses-tab')">üìã D√©penses</button>
    <button onclick="showTab('balances-tab')">üí∞ Soldes</button>
    <button onclick="showTab('settlement-tab')">üí∏ Remboursements</button>
  </div>

  <!-- Onglet : Informations du groupe -->
  <div id="info-tab" class="tab active">
    <section id="group-info">Chargement des infos du groupe...</section>
    <section id="group-role"></section>
    <section id="group-members"></section>
  </div>

  <!-- Onglet : Cr√©ation d‚Äôune d√©pense -->
  <div id="create-tab" class="tab">
    <h2>Cr√©er une nouvelle d√©pense</h2>
    <form id="expense-form" enctype="multipart/form-data">
      <input type="text" id="expense-title" placeholder="Intitul√©" required>
      <input type="number" id="expense-amount" placeholder="Montant (‚Ç¨)" required>
      <input type="date" id="expense-date" required>
      <input type="text" id="expense-category" placeholder="Cat√©gorie" required>
      <input type="text" id="expense-users" placeholder="IDs des utilisateurs concern√©s (ex: 1,2)" required>
      <input type="file" id="expense-receipt" accept=".pdf,image/*">
      <button type="submit">Ajouter la d√©pense</button>
    </form>
    <p id="expense-result"></p>
  </div>

  <!-- Onglet : Liste des d√©penses -->
  <div id="expenses-tab" class="tab">
    <h2>D√©penses du groupe</h2>
    <label for="sort-expenses">Trier par :</label>
    <select id="sort-expenses">
      <option value="date">Date</option>
      <option value="amount">Montant</option>
      <option value="paidBy">Pay√© par</option>
    </select>
    <ul id="group-expenses">Chargement...</ul>
  </div>

  <!-- Onglet : Soldes -->
  <div id="balances-tab" class="tab">
    <h2>Soldes des membres</h2>
    <ul id="group-balances">Chargement...</ul>
  </div>

  <!-- Onglet : Remboursements -->
    <div id="settlement-tab" class="tab">
        <h2>Remboursements par d√©pense</h2>
        <label for="settlement-select">Choisir une d√©pense :</label>
        <select id="settlement-select">
            <option disabled selected>Chargement...</option>
        </select>
        <ul id="settlement-results"></ul>
    </div>


    <script>
        const token = localStorage.getItem('jwt');
        const groupId = {{ groupId }};
        let rawExpenses = [];

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        if (!token) {
            window.location.href = '/login';
        } else {
            Promise.all([
            fetch(`http://localhost:49162/api/groups/${groupId}`, { headers: { 'Authorization': 'Bearer ' + token }}).then(r => r.json()),
            fetch(`http://localhost:49162/api/groups/${groupId}/role`, { headers: { 'Authorization': 'Bearer ' + token }}).then(r => r.json()),
            fetch(`http://localhost:49162/api/groups/${groupId}/members`, { headers: { 'Authorization': 'Bearer ' + token }}).then(r => r.json()),
            fetch(`http://localhost:49162/api/groups/${groupId}/expenses`, { headers: { 'Authorization': 'Bearer ' + token }}).then(r => r.json()),
            fetch(`http://localhost:49162/api/groups/${groupId}/balances`, { headers: { 'Authorization': 'Bearer ' + token }}).then(r => r.json())
            ])
            .then(([group, role, members, expenses, balances]) => {
            // Infos groupe
            document.getElementById('group-info').innerHTML = `
                <h2>${group.name}</h2>
                <p>Cr√©√© le : ${group.createdAt}</p>
                <p>Cr√©√© par : ${group.createdBy.username} (${group.createdBy.email})</p>
            `;
            document.getElementById('group-role').innerHTML = `<strong>Mon r√¥le :</strong> ${role.role}`;
            document.getElementById('group-members').innerHTML = `
                <h3>Membres :</h3>
                <ul>${members.map(m => `<li><strong>${m.username}</strong> (${m.email}) ‚Äì <em>${m.role}</em></li>`).join('')}</ul>
            `;

            // D√©penses
            rawExpenses = expenses;
            renderExpenses(expenses);

            // Soldes
            document.getElementById('group-balances').innerHTML = Object.entries(balances).map(
                ([uid, solde]) => `<li>Utilisateur #${uid} : ${parseFloat(solde).toFixed(2)} ‚Ç¨</li>`
            ).join('');

            // Remplir le select des d√©penses pour remboursements
            const settlementSelect = document.getElementById('settlement-select');
            const settlementResults = document.getElementById('settlement-results');

            if (expenses.length === 0) {
                settlementSelect.innerHTML = `<option disabled>Aucune d√©pense</option>`;
            } else {
                settlementSelect.innerHTML = `<option disabled selected>Choisir une d√©pense</option>`;
                expenses.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = `${e.title} ‚Äì ${e.amount} ‚Ç¨`;
                settlementSelect.appendChild(opt);
                });

                // Au changement de s√©lection, afficher remboursements
                settlementSelect.addEventListener('change', () => {
                  const expenseId = settlementSelect.value;

                  fetch(`http://localhost:49162/api/expenses/${expenseId}/settlements`, {
                    headers: {
                      'Authorization': 'Bearer ' + token
                    }
                  })
                  .then(res => res.json())
                  .then(data => {
                    const container = document.getElementById('settlement-results');

                    if (!data.settlements || !data.settlements.length) {
                      container.innerHTML = '<li>Aucun remboursement √† effectuer pour cette d√©pense.</li>';
                      return;
                    }

                    const settlementsHTML = data.settlements.map(s => {
                      const fromUser = s.from;
                      const toUser = s.to;
                      return `<li>L'utilisateur #${fromUser} doit <strong>${s.amount.toFixed(2)} ‚Ç¨</strong> √† l'utilisateur #${toUser}</li>`;
                    }).join('');

                    container.innerHTML = `
                      <h4>Remboursements pour la d√©pense : <em>${data.expense.title}</em></h4>
                      <ul>${settlementsHTML}</ul>
                      <p><strong>Pay√© par :</strong> ${data.expense.paid_by} | <strong>Montant total :</strong> ${data.expense.amount.toFixed(2)} ‚Ç¨</p>
                    `;
                  })
                  .catch(error => {
                    console.error("Erreur :", error);
                    document.getElementById('settlement-results').innerHTML = '<li>Erreur lors du chargement des remboursements.</li>';
                  });
                });


            }
            });

            function renderExpenses(expenses) {
            const list = document.getElementById('group-expenses');
            if (!expenses.length) {
                list.innerHTML = '<li>Aucune d√©pense.</li>';
                return;
            }
            list.innerHTML = expenses.map(e => `
                <li>
                <strong>${e.title}</strong> ‚Äì ${e.amount} ‚Ç¨<br>
                Cat√©gorie : ${e.category} | Date : ${e.date}<br>
                Pay√© par : ${e.paidBy}<br>
                Participants : ${e.concernedUsers.join(', ')}
                </li><br>
            `).join('');
            }

            document.getElementById('sort-expenses').addEventListener('change', e => {
            const sorted = [...rawExpenses];
            const by = e.target.value;
            sorted.sort((a, b) => {
                if (by === 'amount') return b.amount - a.amount;
                if (by === 'paidBy') return a.paidBy.localeCompare(b.paidBy);
                if (by === 'date') return new Date(b.date) - new Date(a.date);
                return 0;
            });
            renderExpenses(sorted);
            });

            document.getElementById('expense-form').addEventListener('submit', e => {
            e.preventDefault();

            const form = new FormData();
            form.append('title', document.getElementById('expense-title').value.trim());
            form.append('amount', document.getElementById('expense-amount').value);
            form.append('date', document.getElementById('expense-date').value);
            form.append('category', document.getElementById('expense-category').value.trim());
            form.append('group_id', groupId);

            const users = document.getElementById('expense-users').value
                .split(',').map(id => parseInt(id.trim())).filter(Boolean);
            form.append('concerned_user_ids', JSON.stringify(users));

            const file = document.getElementById('expense-receipt').files[0];
            if (file) form.append('receipt', file);

            fetch('http://localhost:49162/api/expenses', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: form
            }).then(async res => {
                const msg = await res.json();
                document.getElementById('expense-result').textContent = msg.message || msg.error;
                if (res.ok) location.reload();
            });
            });
        }
    </script>

</body>
</html>
